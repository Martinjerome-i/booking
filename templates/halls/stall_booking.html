<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Briyani Expo - Enhanced Stall Booking System</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            /* background: linear-gradient(135deg, #FF6B35 0%, #F7931E 50%, #FFD23F 100%); */
            background: linear-gradient(135deg, #6e000a 0%, #c30000 50%, #000000 100%);
            min-height: 100vh;
            color: white;
            position: relative;
            overflow-x: auto;
        }

        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><pattern id="grain" width="100" height="100" patternUnits="userSpaceOnUse"><circle cx="20" cy="20" r="1" fill="rgba(255,255,255,0.1)"/><circle cx="80" cy="40" r="0.5" fill="rgba(255,255,255,0.08)"/><circle cx="40" cy="80" r="1.5" fill="rgba(255,255,255,0.05)"/></pattern></defs><rect width="100" height="100" fill="url(%23grain)"/></svg>');
            opacity: 0.4;
            pointer-events: none;
            z-index: 0;
        }

        .container {
            max-width: 1900px;
            margin: 0 auto;
            padding: 20px;
            position: relative;
            z-index: 1;
        }

        .header {
            background: rgba(139, 0, 0, 0.4);
            backdrop-filter: blur(15px);
            background-image: url('https://i.postimg.cc/2jhttynJ/briyani-expo.jpg');
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            padding: 25px;
            border-radius: 20px;
            margin-bottom: 30px;
            border: 2px solid rgba(255, 215, 0, 0.3);
            box-shadow: 0 8px 32px rgba(139, 0, 0, 0.4);
            text-align: center;
            position: relative;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-image: url('https://i.postimg.cc/2jhttynJ/briyani-expo.jpg');
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            filter: blur(2px);
            z-index: 1;
        }

        .header::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(45deg, transparent 30%, rgba(255, 215, 0, 0.1) 50%, transparent 70%);
            animation: shimmer 3s ease-in-out infinite;
            z-index: 2;
        }

        @keyframes shimmer {
            0%, 100% { transform: translateX(-100%); }
            50% { transform: translateX(100%); }
        }

        .logo {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            margin-bottom: 20px;
            position: relative;
            z-index: 3;
        }

        .logo-img {
            width: 180px;
            aspect-ratio: 2.15;
            object-fit: contain;
            /* border-radius: 50%; */
            /* border: 3px solid rgba(255, 255, 255, 0.3); */
            /* box-shadow: 0 8px 24px rgba(255, 215, 0, 0.4); */
            /* animation: pulse 2s ease-in-out infinite; */
            /* object-fit: cover; */
            position: relative;
            z-index: 3;
        }

        .logo-text {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
        }

        .expo-text {
            font-size: 32px;
            font-weight: bold;
            background: linear-gradient(45deg, #FFD700, #FF4500);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            filter: drop-shadow(2px 2px 4px rgba(0, 0, 0, 0.6));
            letter-spacing: 2px;
        }

        .year {
            font-size: 14px;
            color: #FFD700;
            font-weight: bold;
            margin-top: -5px;
            letter-spacing: 3px;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.8);
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); box-shadow: 0 8px 24px rgba(255, 215, 0, 0.4); }
            50% { transform: scale(1.05); box-shadow: 0 12px 32px rgba(255, 215, 0, 0.6); }
        }

        .header h1 {
            font-size: 36px;
            font-weight: bold;
            margin-bottom: 15px;
            background: linear-gradient(45deg, #FFD700, #FF4500);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            position: relative;
            z-index: 3;
            filter: drop-shadow(2px 2px 4px rgba(0, 0, 0, 0.8));
        }

        .header p {
            font-size: 18px;
            opacity: 0.95;
            margin-bottom: 20px;
            color: #FFFFE0;
            position: relative;
            z-index: 3;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.8);
        }
        
        .header:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 40px rgba(139, 0, 0, 0.5);
        }

        .expo-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 20px;
            position: relative;
            z-index: 3;
        }

        .stat-item {
            background: rgba(139, 0, 0, 0.2);
            padding: 15px;
            border-radius: 12px;
            text-align: center;
            border: 2px solid rgba(255, 215, 0, 0.2);
            backdrop-filter: blur(10px);
            transition: all 0.3s ease;
        }

        .stat-item:hover {
            background: rgba(139, 0, 0, 0.3);
            border-color: rgba(255, 215, 0, 0.4);
            transform: translateY(-2px);
        }

        .stat-number {
            font-size: 24px;
            font-weight: bold;
            color: #FFD700;
            margin-bottom: 5px;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.8);
        }

        .stat-label {
            font-size: 14px;
            opacity: 0.9;
            color: #FFFFE0;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.6);
        }

        .content {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            padding: 30px;
            border-radius: 15px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.2);
        }

        .content h2 {
            color: #fff;
            margin-bottom: 15px;
            font-size: 1.8rem;
        }

        .main-layout {
            display: grid;
            grid-template-columns: 1fr 450px;
            gap: 30px;
            align-items: start;
        }

        .expo-floor {
            background: rgba(139, 0, 0, 0.3);
            backdrop-filter: blur(15px);
            padding: 30px;
            border-radius: 20px;
            border: 2px solid rgba(255, 215, 0, 0.2);
            box-shadow: 0 8px 32px rgba(139, 0, 0, 0.4);
            overflow-x: auto;
        }

        .floor-title {
            text-align: center;
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 20px;
            color: #FFD700;
        }

        .floor-info {
            text-align: center;
            margin-bottom: 25px;
            background: rgba(139, 0, 0, 0.2);
            padding: 15px;
            border-radius: 12px;
            border: 1px solid rgba(255, 215, 0, 0.2);
        }

        .selection-controls {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .control-button {
            padding: 10px 20px;
            background: linear-gradient(45deg, #DC143C, #FFC107);
            border: none;
            border-radius: 8px;
            color: white;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            border: 2px solid rgba(255, 215, 0, 0.3);
        }

        .control-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(220, 20, 60, 0.4);
        }

        .stall-legend {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-bottom: 25px;
            flex-wrap: wrap;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            background: rgba(139, 0, 0, 0.2);
            padding: 10px 15px;
            border-radius: 10px;
            font-size: 14px;
            border: 1px solid rgba(255, 215, 0, 0.2);
        }

        .legend-color {
            width: 20px;
            height: 20px;
            border-radius: 4px;
            border: 2px solid rgba(255, 215, 0, 0.4);
        }

        .stall-sections {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 20px;
            min-width: 1200px;
        }

        .stall-section {
            background: rgba(139, 0, 0, 0.15);
            border-radius: 12px;
            padding: 15px;
            border: 2px solid rgba(255, 215, 0, 0.2);
        }

        .section-title {
            text-align: center;
            font-weight: bold;
            margin-bottom: 15px;
            font-size: 14px;
            color: #FFD700;
        }

        .stall-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
        }

        .stall {
            aspect-ratio: 1;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s;
            border: 2px solid transparent;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 11px;
            font-weight: bold;
            position: relative;
            overflow: hidden;
            min-height: 40px;
        }

        .stall.eatery {
            background: linear-gradient(135deg, #228B22, #32CD32);
            color: white;
        }

        .stall.non-eatery {
            background: linear-gradient(135deg, #4169E1, #1E90FF);
            color: white;
        }

        .stall.selected {
            background: linear-gradient(135deg, #DC143C, #B22222) !important;
            transform: scale(1.1);
            box-shadow: 0 0 20px rgba(220, 20, 60, 0.8);
            z-index: 10;
            animation: pulse 2s infinite;
            border: 2px solid #FFD700 !important;
        }

        .stall.occupied {
            background: linear-gradient(135deg, #696969, #2F2F2F) !important;
            cursor: not-allowed;
            opacity: 0.5;
        }

        .stall:hover:not(.occupied) {
            transform: scale(1.05);
            box-shadow: 0 5px 15px rgba(255, 215, 0, 0.5);
            border: 2px solid rgba(255, 215, 0, 0.6);
        }

        @keyframes pulse {
            0%, 100% { box-shadow: 0 0 0 0 rgba(220, 20, 60, 0.8); }
            50% { box-shadow: 0 0 0 10px rgba(220, 20, 60, 0); }
        }

        .booking-panel {
            background: rgba(139, 0, 0, 0.4);
            backdrop-filter: blur(15px);
            padding: 30px;
            border-radius: 20px;
            border: 2px solid rgba(255, 215, 0, 0.3);
            box-shadow: 0 8px 32px rgba(139, 0, 0, 0.4);
            position: sticky;
            top: 20px;
            height: fit-content;
            max-height: 90vh;
            overflow-y: auto;
        }

        .panel-header {
            text-align: center;
            margin-bottom: 25px;
            padding-bottom: 20px;
            border-bottom: 2px solid rgba(255, 215, 0, 0.2);
        }

        .panel-header h3 {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 10px;
            color: #FFD700;
        }

        .selected-stalls-list {
            background: rgba(139, 0, 0, 0.2);
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
            border: 2px solid rgba(255, 215, 0, 0.2);
            max-height: 200px;
            overflow-y: auto;
        }

        .selected-stalls-title {
            font-size: 16px;
            font-weight: bold;
            color: #FFD700;
            margin-bottom: 15px;
            text-align: center;
        }

        .selected-stall-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            background: rgba(220, 20, 60, 0.2);
            border-radius: 8px;
            margin-bottom: 8px;
            border: 1px solid rgba(255, 215, 0, 0.2);
        }

        .stall-remove-btn {
            background: #B22222;
            border: none;
            color: white;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .stall-remove-btn:hover {
            background: #DC143C;
            transform: scale(1.1);
        }

        .booking-form {
            margin-bottom: 20px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            font-size: 14px;
            font-weight: bold;
            margin-bottom: 8px;
            color: #FFD700;
        }

        .form-control {
            width: 100%;
            padding: 12px;
            border: 2px solid rgba(255, 215, 0, 0.3);
            border-radius: 10px;
            background: rgba(139, 0, 0, 0.2);
            color: white;
            font-size: 14px;
            transition: all 0.3s;
        }

        .form-control:focus {
            outline: none;
            border-color: #FFD700;
            background: rgba(139, 0, 0, 0.3);
            box-shadow: 0 0 10px rgba(255, 215, 0, 0.3);
        }

        .form-control::placeholder {
            color: rgba(255, 255, 224, 0.6);
        }

        .price-breakdown {
            background: rgba(220, 20, 60, 0.2);
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 25px;
            border: 2px solid rgba(255, 215, 0, 0.4);
        }

        .price-title {
            font-size: 18px;
            font-weight: bold;
            color: #FFD700;
            margin-bottom: 15px;
            text-align: center;
        }

        .price-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            font-size: 14px;
            padding: 8px 0;
            color: #FFFFE0;
        }

        .price-total {
            border-top: 2px solid rgba(255, 215, 0, 0.5);
            padding-top: 15px;
            margin-top: 15px;
            font-size: 20px;
            font-weight: bold;
            color: #FFD700;
        }

        .bulk-discount {
            background: rgba(34, 139, 34, 0.3);
            padding: 10px;
            border-radius: 8px;
            margin: 10px 0;
            border: 1px solid rgba(255, 215, 0, 0.3);
            text-align: center;
            font-size: 13px;
            color: #98FB98;
        }

        
        .date-selector {
            display: flex;
            gap: 10px;
            margin-bottom: 25px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .date-item {
            padding: 12px 16px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            min-width: 70px;
            border: 2px solid transparent;
        }

        .date-item:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-3px);
        }

        /* .date-item.active {
            background: linear-gradient(135deg, #ff1744, #d50000) !important;
            border-color: #ff5722 !important;
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(255, 23, 68, 0.4);
        } */


        .book-button {
            width: 100%;
            padding: 18px;
            background: linear-gradient(45deg, #DC143C, #B22222);
            border: 2px solid #FFD700;
            border-radius: 15px;
            color: white;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            text-transform: uppercase;
            letter-spacing: 1px;
            box-shadow: 0 8px 25px rgba(220, 20, 60, 0.4);
            margin-bottom: 20px;
        }

        .book-button:hover:not(:disabled) {
            transform: translateY(-3px);
            box-shadow: 0 12px 35px rgba(220, 20, 60, 0.6);
            background: linear-gradient(45deg, #B22222, #8B0000);
        }

        .book-button:disabled {
            background: linear-gradient(45deg, #696969, #2F2F2F);
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
            border-color: rgba(255, 215, 0, 0.2);
        }

        .booking-features {
            background: rgba(139, 0, 0, 0.2);
            padding: 20px;
            border-radius: 15px;
            font-size: 13px;
            line-height: 1.6;
            border: 1px solid rgba(255, 215, 0, 0.2);
        }

        .features-title {
            font-size: 16px;
            font-weight: bold;
            color: #FFD700;
            margin-bottom: 15px;
            text-align: center;
        }

        .features-list {
            list-style: none;
            padding: 0;
        }

        .features-list li {
            margin-bottom: 8px;
            padding-left: 20px;
            position: relative;
            color: #FFFFE0;
        }

        .features-list li::before {
            content: '‚úì';
            position: absolute;
            left: 0;
            color: #32CD32;
            font-weight: bold;
            font-size: 14px;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(5px);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.show {
            display: flex;
        }

        .modal-content {
            background: rgba(139, 0, 0, 0.95);
            backdrop-filter: blur(20px);
            padding: 40px;
            border-radius: 20px;
            border: 3px solid #FFD700;
            max-width: 600px;
            width: 90%;
            text-align: center;
            box-shadow: 0 20px 60px rgba(139, 0, 0, 0.8);
        }

        .modal-title {
            font-size: 28px;
            font-weight: bold;
            color: #FFD700;
            margin-bottom: 20px;
        }

        .modal-text {
            font-size: 16px;
            line-height: 1.6;
            margin-bottom: 30px;
            opacity: 0.95;
            color: #FFFFE0;
        }

        .modal-button {
            padding: 15px 30px;
            background: linear-gradient(45deg, #32CD32, #228B22);
            border: 2px solid #FFD700;
            border-radius: 10px;
            color: white;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            margin: 0 10px;
        }

        .modal-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(50, 205, 50, 0.4);
        }

        .search-filter {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .filter-select {
            padding: 10px;
            border-radius: 8px;
            border: 2px solid rgba(255, 215, 0, 0.3);
            background: rgba(139, 0, 0, 0.2);
            color: white;
            font-size: 14px;
        }

        .filter-select option {
            background: #8B0000;
            color: white;
        }

        .stall-tooltip {
            position: absolute;
            background: rgba(139, 0, 0, 0.95);
            color: white;
            padding: 12px 16px;
            border-radius: 8px;
            font-size: 12px;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.3s;
            z-index: 1000;
            max-width: 200px;
            border: 2px solid rgba(255, 215, 0, 0.5);
            box-shadow: 0 5px 15px rgba(139, 0, 0, 0.8);
        }

        .quick-select-buttons {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .quick-select-btn {
            padding: 8px 16px;
            background: linear-gradient(45deg, #FF8C00, #FF6347);
            border: 1px solid rgba(255, 215, 0, 0.3);
            border-radius: 6px;
            color: white;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .quick-select-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 3px 8px rgba(255, 140, 0, 0.4);
        }

        @media (max-width: 1400px) {
            .main-layout {
                grid-template-columns: 1fr;
                gap: 20px;
            }
            
            .booking-panel {
                position: relative;
                top: 0;
                order: -1;
                max-height: none;
            }

            .stall-sections {
                grid-template-columns: repeat(3, 1fr);
                min-width: 900px;
            }
        }

        @media (max-width: 1000px) {
            .stall-sections {
                grid-template-columns: repeat(2, 1fr);
                min-width: 600px;
            }
        }

        @media (max-width: 768px) {
            .stall-sections {
                grid-template-columns: 1fr;
                min-width: 300px;
            }
            
            .expo-stats {
                grid-template-columns: repeat(2, 1fr);
            }

            .header h1 {
                font-size: 28px;
            }

            .stall-legend {
                gap: 10px;
            }

            .legend-item {
                font-size: 12px;
                padding: 8px 12px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header Section -->
            <div class="header">
                <div class="logo">
                    <img src="https://cdn.builder.io/api/v1/image/assets/TEMP/e5944c534807307b24c0d2fe7e48cf087f874c02f091ba1ed0ed4b358304e2ef?placeholderIfAbsent=true&apiKey=a2777fa846d94c9ebc9cc0fdf59a2081" alt="Briyani Expo Logo" class="logo-img">
                    <div class="logo-text">
                        <span class="expo-text">EXPO</span>
                        <span class="year">2025</span>
                    </div>
                </div>
                <!-- <h1>üçõ Briyani Expo 2024</h1> -->
                <p>Enhanced Multi-Stall Booking System - Select Multiple Stalls</p>
                <div class="expo-stats">
                    <div class="stat-item">
                        <div class="stat-number">268</div>
                        <div class="stat-label">Total Stalls</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number" id="availableCount">250</div>
                        <div class="stat-label">Available</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number" id="selectedCount">0</div>
                        <div class="stat-label">Selected</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number">‚Çπ15,000</div>
                        <div class="stat-label">Starting Price</div>
                    </div>
                </div>
            </div>

        <div class="main-layout">
            <!-- Expo Floor Plan -->
            <div class="expo-floor">
                <!-- date-selector -->
                <div class="date-selector">
                    <div class="date-item">
                        <div style="font-size: 16px;">20</div>
                        <div style="font-size: 11px;">Day 1</div>
                    </div>
                    <div class="date-item active">
                        <div style="font-size: 16px;">21</div>
                        <div style="font-size: 11px;">Day 2</div>
                    </div>
                    <div class="date-item">
                        <div style="font-size: 16px;">22</div>
                        <div style="font-size: 11px;">Day 3</div>
                    </div>
                    <!-- <div class="date-item">
                        <div style="font-size: 14px;">ALL</div>
                        <div style="font-size: 11px;">3 Days</div>
                    </div> -->
                </div>
                <div class="floor-info">
                    <strong>Size:</strong> 100m x 44m (4400m¬≤) | <strong>Capacity:</strong> 268 Stalls
                    <br><strong>Multi-Selection Mode:</strong> Click multiple stalls to add to your booking
                </div>

                

                <!-- Quick Select Buttons -->
                <div class="quick-select-buttons">
                    <button class="quick-select-btn" onclick="quickSelectConsecutive(3)">3 Consecutive</button>
                    <button class="quick-select-btn" onclick="quickSelectConsecutive(5)">5 Consecutive</button>
                    <button class="quick-select-btn" onclick="quickSelectCornerStalls()">Corner Stalls</button>
                    <button class="quick-select-btn" onclick="quickSelectCenterStalls()">Center Stalls</button>
                </div>

                <!-- Search and Filter Options -->
                <div class="search-filter">
                    <select class="filter-select" id="typeFilter">
                        <option value="all">All Stalls</option>
                        <option value="eatery">Eatery Only</option>
                        <option value="non-eatery">Non-Eatery Only</option>
                        <option value="available">Available Only</option>
                    </select>
                    <!-- <select class="filter-select" id="sectionFilter">
                        <option value="all">All Sections</option>
                        <option value="section1">Section 1-53</option>
                        <option value="section2">Section 54-107</option>
                        <option value="section3">Section 108-161</option>
                        <option value="section4">Section 162-215</option>
                        <option value="section5">Section 216-268</option>
                    </select>
                    <select class="filter-select" id="priceFilter">
                        <option value="all">All Prices</option>
                        <option value="budget">Budget (‚Çπ10k-‚Çπ12k)</option>
                        <option value="standard">Standard (‚Çπ12k-‚Çπ15k)</option>
                        <option value="premium">Premium (‚Çπ15k+)</option>
                    </select> -->
                </div>

                <!-- Legend -->
                <div class="stall-legend">
                    <div class="legend-item">
                        <div class="legend-color" style="background: linear-gradient(135deg, #228B22, #32CD32);"></div>
                        <span>Eatery Stalls</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: linear-gradient(135deg, #4169E1, #1E90FF);"></div>
                        <span>Non-Eatery Stalls</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: linear-gradient(135deg, #DC143C, #B22222);"></div>
                        <span>Selected</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: linear-gradient(135deg, #696969, #2F2F2F);"></div>
                        <span>Occupied</span>
                    </div>
                </div>

                <!-- Stall Sections -->
                <div class="hall-display" id="hall-display"
                style="width: 100%; height: 700px;"
                data-hall-id="{{ hall.id }}"
                data-length="{{ hall.length }}"
                data-breadth="{{ hall.breadth }}">
                <div id="loading" class="loading">
                    <img src="/static/ibfe_logo_1.png" alt="IBFE Logo" class="loading-logo">
                </div>                
                <!-- Stalls will be drawn here using JavaScript -->
            </div>
            </div>

            <!-- Enhanced Booking Panel -->
            <div class="booking-panel">
                <div class="panel-header">
                    <h3>üéØ Multi-Stall Booking</h3>
                    <p>Select multiple stalls for your business</p>
                </div>

                <!-- Selected Stalls List -->
                <div class="selected-stalls-list">
                    <div class="selected-stalls-title">üìã Selected Stalls (<span id="selectedStallCount">0</span>)</div>
                    <div id="selectedStallsList">
                        <div style="text-align: center; color: rgba(255, 255, 224, 0.6); font-style: italic;">
                            No stalls selected. Click on stalls to add them.
                        </div>
                    </div>
                </div>

                <!-- Booking Form -->
                <div class="booking-form">
                    <div class="form-group">
                        <label class="form-label">Business Name *</label>
                        <input type="text" class="form-control" id="businessName" placeholder="Enter your business name" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Contact Person *</label>
                        <input type="text" class="form-control" id="contactPerson" placeholder="Your full name" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Phone Number *</label>
                        <input type="tel" class="form-control" id="phoneNumber" placeholder="+91 XXXXX XXXXX" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Email Address *</label>
                        <input type="email" class="form-control" id="emailAddress" placeholder="your@email.com" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Business Type</label>
                        <select class="form-control" id="businessType">
                            <option value="restaurant">Restaurant/Eatery</option>
                            <option value="retail">Retail Shop</option>
                            <option value="service">Service Provider</option>
                            <option value="exhibition">Exhibition Stall</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                </div>

                <!-- Enhanced Price Breakdown -->
                <div class="price-breakdown">
                    <div class="price-title">üí∞ Price Breakdown</div>
                    <div class="price-row">
                        <span>Base Stalls Price:</span>
                        <span id="basePrice">‚Çπ 0</span>
                    </div>
                    <div class="price-row">
                        <span>Setup & Services (<span id="stallCount">0</span> stalls):</span>
                        <span id="setupCost">‚Çπ 0</span>
                    </div>
                    <div class="price-row">
                        <span>Marketing & Promotion:</span>
                        <span id="marketingCost">‚Çπ 2,500</span>
                    </div>
                    <div class="price-row">
                        <span>Security Deposit:</span>
                        <span id="securityDeposit">‚Çπ 5,000</span>
                    </div>
                    <div id="discountRow" class="price-row" style="display: none; color: #32CD32;">
                        <span>Bulk Discount (<span id="discountPercent">0</span>%):</span>
                        <span id="discountAmount">- ‚Çπ 0</span>
                    </div>
                    <div class="bulk-discount" id="discountInfo" style="display: none;">
                        üéâ Great! You're getting a bulk booking discount!
                    </div>
                    <div class="price-total price-row">
                        <span>Total Amount:</span>
                        <span id="totalPrice">‚Çπ 7,500</span>
                    </div>
                </div>

                <!-- Book Now Button -->
                <button class="book-button" id="bookButton" onclick="proceedToBook()" disabled>
                    üìù Book Selected Stalls
                </button>

                <!-- Booking Features -->
                <div class="booking-features">
                    <div class="features-title">üé™ Expo Features Included</div>
                    <ul class="features-list">
                        <li>Premium location with high foot traffic</li>
                        <li>24/7 security and surveillance</li>
                        <li>Electricity and water connections</li>
                        <li>Free marketing in event promotions</li>
                        <li>Dedicated customer support</li>
                        <li>Parking facilities for vendors</li>
                        <li>Waste management services</li>
                        <li>Wi-Fi connectivity throughout</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <!-- Success Modal -->
    <div class="modal" id="successModal">
        <div class="modal-content">
            <div class="modal-title">üéâ Booking Successful!</div>
            <div class="modal-text" id="bookingDetails">
                Your stall booking has been confirmed. You will receive a confirmation email shortly with payment instructions and event details.
            </div>
            <button class="modal-button" onclick="closeModal()">Continue</button>
        </div>
    </div>

    <!-- Tooltip for stall information -->
    <div class="stall-tooltip" id="stallTooltip"></div>

    <script>
        // Global variables
        let selectedStalls = new Set();
        let stallData = {};
        let occupiedStalls = new Set();
        let occupiedStallsInfo = {}; // Store occupied stall details

        // Initialize the application
        function initializeApp() {
            generateStallData();
            generateOccupiedStalls();
            renderStallSections();
            updateStats();
            setupEventListeners();
        }

        // Generate stall data with random properties
        function generateStallData() {
            for (let i = 1; i <= 268; i++) {
                const isEatery = Math.random() > 0.4; // 60% eatery, 40% non-eatery
                const basePrice = isEatery ? 
                    Math.floor(Math.random() * 8000) + 12000 : // Eatery: 12k-20k
                    Math.floor(Math.random() * 5000) + 10000;  // Non-eatery: 10k-15k
                
                stallData[i] = {
                    id: i,
                    type: isEatery ? 'eatery' : 'non-eatery',
                    price: basePrice,
                    size: isEatery ? '4m x 4m' : '3m x 3m',
                    location: getLocationRating(i),
                    amenities: isEatery ? 
                        ['Kitchen Setup', 'Gas Connection', 'Drainage'] :
                        ['Display Area', 'Storage Space', 'Lighting']
                };
            }
        }

        // Generate some occupied stalls with business details
        function generateOccupiedStalls() {
            const occupiedCount = 18; // 18 out of 268 are occupied
            const businessNames = [
                'A2B Restaurant', 'McDonald\'s', 'KFC', 'Pizza Hut', 'Domino\'s Pizza',
                'Subway', 'Starbucks Coffee', 'Burger King', 'Taco Bell', 'Dunkin\' Donuts',
                'Fashion Hub', 'Tech Zone', 'Book Paradise', 'Sports Corner', 'Jewelry Palace',
                'Mobile World', 'Footwear Express', 'Electronics Mart'
            ];
            
            const businessTypes = [
                'Fast Food', 'Restaurant', 'Coffee Shop', 'Fashion Store', 'Electronics',
                'Bookstore', 'Sports Store', 'Jewelry', 'Mobile Store', 'Footwear'
            ];
            
            const contactNumbers = [
                '+91 98765 43210', '+91 87654 32109', '+91 76543 21098', '+91 65432 10987',
                '+91 54321 09876', '+91 43210 98765', '+91 32109 87654', '+91 21098 76543',
                '+91 10987 65432', '+91 09876 54321', '+91 98765 43211', '+91 87654 32110',
                '+91 76543 21099', '+91 65432 10988', '+91 54321 09877', '+91 43210 98766',
                '+91 32109 87655', '+91 21098 76544'
            ];
            
            let businessIndex = 0;
            while (occupiedStalls.size < occupiedCount) {
                const stallId = Math.floor(Math.random() * 268) + 1;
                if (!occupiedStalls.has(stallId)) {
                    occupiedStalls.add(stallId);
                    
                    // Add business details for this occupied stall
                    occupiedStallsInfo[stallId] = {
                        businessName: businessNames[businessIndex],
                        businessType: businessTypes[businessIndex % businessTypes.length],
                        contactNumber: contactNumbers[businessIndex],
                        ownerName: `Owner ${businessIndex + 1}`,
                        leaseStart: new Date(2024, Math.floor(Math.random() * 12), Math.floor(Math.random() * 28) + 1).toLocaleDateString('en-IN'),
                        leaseEnd: new Date(2025, Math.floor(Math.random() * 12), Math.floor(Math.random() * 28) + 1).toLocaleDateString('en-IN'),
                        monthlyRent: `‚Çπ${(Math.floor(Math.random() * 50000) + 25000).toLocaleString()}`
                    };
                    
                    businessIndex++;
                }
            }
        }

        // Get location rating based on stall position
        function getLocationRating(stallId) {
            // Corner and center stalls get premium rating
            if (stallId <= 20 || stallId >= 249 || 
                (stallId >= 124 && stallId <= 144)) {
                return 'Premium';
            }
            // Edge stalls get standard rating
            if (stallId <= 54 || stallId >= 215) {
                return 'Standard';
            }
            return 'Economy';
        }

        // Render all stall sections
        function renderStallSections() {
            const container = document.getElementById('stallSections');
            container.innerHTML = '';

            for (let section = 1; section <= 5; section++) {
                const sectionDiv = document.createElement('div');
                sectionDiv.className = 'stall-section';
                
                const startStall = (section - 1) * 53 + 1;
                const endStall = Math.min(section * 53, 268);
                
                sectionDiv.innerHTML = `
                    <div class="section-title">Section ${section}<br>(Stalls ${startStall}-${endStall})</div>
                    <div class="stall-grid" id="section${section}Grid"></div>
                `;
                
                container.appendChild(sectionDiv);
                renderStallGrid(section, startStall, endStall);
            }
        }

        // Render individual stall grid for a section
        function renderStallGrid(section, startStall, endStall) {
            const grid = document.getElementById(`section${section}Grid`);
            grid.innerHTML = '';

            for (let i = startStall; i <= endStall; i++) {
                const stall = document.createElement('div');
                stall.className = `stall ${stallData[i].type}`;
                stall.id = `stall-${i}`;
                stall.textContent = i;
                
                if (occupiedStalls.has(i)) {
                    stall.classList.add('occupied');
                    stall.onmouseenter = (e) => showOccupiedTooltip(e, i);
                    stall.onmouseleave = hideTooltip;
                } else {
                    stall.onclick = () => toggleStallSelection(i);
                    stall.onmouseenter = (e) => showTooltip(e, i);
                    stall.onmouseleave = hideTooltip;
                }
                
                grid.appendChild(stall);
            }
        }

        // Toggle stall selection
        function toggleStallSelection(stallId) {
            if (occupiedStalls.has(stallId)) return;

            const stallElement = document.getElementById(`stall-${stallId}`);
            
            if (selectedStalls.has(stallId)) {
                selectedStalls.delete(stallId);
                stallElement.classList.remove('selected');
            } else {
                selectedStalls.add(stallId);
                stallElement.classList.add('selected');
            }
            
            updateSelectedStallsList();
            updatePricing();
            updateStats();
        }

        // Update selected stalls list in booking panel
        function updateSelectedStallsList() {
            const container = document.getElementById('selectedStallsList');
            const countElement = document.getElementById('selectedStallCount');
            
            countElement.textContent = selectedStalls.size;
            
            if (selectedStalls.size === 0) {
                container.innerHTML = `
                    <div style="text-align: center; color: rgba(255, 255, 224, 0.6); font-style: italic;">
                        No stalls selected. Click on stalls to add them.
                    </div>
                `;
                return;
            }
            
            const stallsList = Array.from(selectedStalls).sort((a, b) => a - b);
            container.innerHTML = stallsList.map(stallId => `
                <div class="selected-stall-item">
                    <div>
                        <strong>Stall ${stallId}</strong><br>
                        <small>${stallData[stallId].type} - ‚Çπ${stallData[stallId].price.toLocaleString()}</small>
                    </div>
                    <button class="stall-remove-btn" onclick="removeStall(${stallId})" title="Remove stall">√ó</button>
                </div>
            `).join('');
        }

        // Remove individual stall
        function removeStall(stallId) {
            selectedStalls.delete(stallId);
            document.getElementById(`stall-${stallId}`).classList.remove('selected');
            updateSelectedStallsList();
            updatePricing();
            updateStats();
        }

        // Update pricing calculations
        function updatePricing() {
            const basePrice = Array.from(selectedStalls).reduce((sum, stallId) => 
                sum + stallData[stallId].price, 0);
            
            const setupCost = selectedStalls.size * 1500; // ‚Çπ1500 per stall
            const marketingCost = 2500;
            const securityDeposit = 5000;
            
            // Calculate bulk discount
            let discountPercent = 0;
            let discountAmount = 0;
            
            if (selectedStalls.size >= 10) {
                discountPercent = 15;
            } else if (selectedStalls.size >= 5) {
                discountPercent = 10;
            } else if (selectedStalls.size >= 3) {
                discountPercent = 5;
            }
            
            if (discountPercent > 0) {
                discountAmount = Math.floor((basePrice + setupCost) * discountPercent / 100);
            }
            
            const totalPrice = basePrice + setupCost + marketingCost + securityDeposit - discountAmount;
            
            // Update display
            document.getElementById('basePrice').textContent = `‚Çπ ${basePrice.toLocaleString()}`;
            document.getElementById('setupCost').textContent = `‚Çπ ${setupCost.toLocaleString()}`;
            document.getElementById('stallCount').textContent = selectedStalls.size;
            document.getElementById('totalPrice').textContent = `‚Çπ ${totalPrice.toLocaleString()}`;
            
            // Show/hide discount
            const discountRow = document.getElementById('discountRow');
            const discountInfo = document.getElementById('discountInfo');
            
            if (discountPercent > 0) {
                discountRow.style.display = 'flex';
                discountInfo.style.display = 'block';
                document.getElementById('discountPercent').textContent = discountPercent;
                document.getElementById('discountAmount').textContent = `‚Çπ ${discountAmount.toLocaleString()}`;
            } else {
                discountRow.style.display = 'none';
                discountInfo.style.display = 'none';
            }
            
            // Enable/disable book button
            const bookButton = document.getElementById('bookButton');
            bookButton.disabled = selectedStalls.size === 0;
        }

        // Update statistics
        function updateStats() {
            const availableCount = 268 - occupiedStalls.size;
            const selectedCount = selectedStalls.size;
            
            document.getElementById('availableCount').textContent = availableCount - selectedCount;
            document.getElementById('selectedCount').textContent = selectedCount;
        }

        // Show tooltip for available stalls
        function showTooltip(event, stallId) {
            const tooltip = document.getElementById('stallTooltip');
            const stall = stallData[stallId];
            
            tooltip.innerHTML = `
                <strong>Stall ${stallId}</strong><br>
                Type: ${stall.type}<br>
                Size: ${stall.size}<br>
                Price: ‚Çπ${stall.price.toLocaleString()}<br>
                Location: ${stall.location}<br>
                Status: Available
            `;
            
            tooltip.style.left = event.pageX + 10 + 'px';
            tooltip.style.top = event.pageY - 10 + 'px';
            tooltip.style.opacity = '1';
        }

        // Show detailed tooltip for occupied stalls
        function showOccupiedTooltip(event, stallId) {
            const tooltip = document.getElementById('stallTooltip');
            const stall = stallData[stallId];
            const businessInfo = occupiedStallsInfo[stallId];
            
            tooltip.innerHTML = `
                <div style="border-bottom: 1px solid #ddd; padding-bottom: 8px; margin-bottom: 8px;">
                    <strong style="color: #FFD700;">Stall ${stallId} - OCCUPIED</strong>
                </div>
                <div style="margin-bottom: 8px;">
                    <strong style="color: #1976d2;">${businessInfo.businessName}</strong><br>
                    <small style="color: #fff;">Business Type: ${businessInfo.businessType}</small>
                </div>
                <div style="font-size: 12px; line-height: 1.4;">
                    <strong>Owner:</strong> ${businessInfo.ownerName}<br>
                    <strong>Contact:</strong> ${businessInfo.contactNumber}<br>
                    <strong>Monthly Rent:</strong> ${businessInfo.monthlyRent}<br>
                    <strong>Lease Period:</strong><br>
                    ${businessInfo.leaseStart} to ${businessInfo.leaseEnd}
                </div>
                <div style="margin-top: 8px; padding-top: 8px; border-top: 1px solid #ddd; font-size: 11px; color: #fff;">
                    Stall Details: ${stall.type} | ${stall.size} | ${stall.location} Location
                </div>
            `;
            
            tooltip.style.left = event.pageX + 10 + 'px';
            tooltip.style.top = event.pageY - 10 + 'px';
            tooltip.style.opacity = '1';
            tooltip.style.minWidth = '280px';
            tooltip.style.maxWidth = '320px';
        }

        // Hide tooltip
        function hideTooltip() {
            const tooltip = document.getElementById('stallTooltip');
            tooltip.style.opacity = '0';
            tooltip.style.minWidth = 'auto';
            tooltip.style.maxWidth = 'none';
        }

        // Control functions
        function clearAllSelections() {
            selectedStalls.forEach(stallId => {
                document.getElementById(`stall-${stallId}`).classList.remove('selected');
            });
            selectedStalls.clear();
            updateSelectedStallsList();
            updatePricing();
            updateStats();
        }

        function selectRandomStalls(count) {
            clearAllSelections();
            const availableStalls = [];
            for (let i = 1; i <= 268; i++) {
                if (!occupiedStalls.has(i)) {
                    availableStalls.push(i);
                }
            }
            
            for (let i = 0; i < Math.min(count, availableStalls.length); i++) {
                const randomIndex = Math.floor(Math.random() * availableStalls.length);
                const stallId = availableStalls.splice(randomIndex, 1)[0];
                toggleStallSelection(stallId);
            }
        }

        function selectBestStalls() {
            clearAllSelections();
            const premiumStalls = [];
            for (let i = 1; i <= 268; i++) {
                if (!occupiedStalls.has(i) && stallData[i].location === 'Premium') {
                    premiumStalls.push(i);
                }
            }
            
            premiumStalls.slice(0, 5).forEach(stallId => {
                toggleStallSelection(stallId);
            });
        }

        function selectBySection() {
            const sectionNum = Math.floor(Math.random() * 5) + 1;
            const startStall = (sectionNum - 1) * 53 + 1;
            const endStall = Math.min(sectionNum * 53, 268);
            
            clearAllSelections();
            
            let selected = 0;
            for (let i = startStall; i <= endStall && selected < 3; i++) {
                if (!occupiedStalls.has(i)) {
                    toggleStallSelection(i);
                    selected++;
                }
            }
        }

        function quickSelectConsecutive(count) {
            clearAllSelections();
            
            for (let start = 1; start <= 268 - count + 1; start++) {
                let canSelect = true;
                for (let i = start; i < start + count; i++) {
                    if (occupiedStalls.has(i)) {
                        canSelect = false;
                        break;
                    }
                }
                
                if (canSelect) {
                    for (let i = start; i < start + count; i++) {
                        toggleStallSelection(i);
                    }
                    break;
                }
            }
        }

        function quickSelectCornerStalls() {
            clearAllSelections();
            const cornerStalls = [1, 20, 54, 73, 107, 126, 161, 180, 215, 234, 268];
            
            cornerStalls.forEach(stallId => {
                if (!occupiedStalls.has(stallId)) {
                    toggleStallSelection(stallId);
                }
            });
        }

        function quickSelectCenterStalls() {
            clearAllSelections();
            const centerStalls = [134, 135, 140, 141, 142];
            
            centerStalls.forEach(stallId => {
                if (!occupiedStalls.has(stallId)) {
                    toggleStallSelection(stallId);
                }
            });
        }

        // Booking process
        function proceedToBook() {
            const businessName = document.getElementById('businessName').value;
            const contactPerson = document.getElementById('contactPerson').value;
            const phoneNumber = document.getElementById('phoneNumber').value;
            const emailAddress = document.getElementById('emailAddress').value;
            
            if (!businessName || !contactPerson || !phoneNumber || !emailAddress) {
                alert('Please fill in all required fields before booking.');
                return;
            }
            
            if (selectedStalls.size === 0) {
                alert('Please select at least one stall to proceed with booking.');
                return;
            }
            
            showBookingConfirmation();
        }

        function showBookingConfirmation() {
            const stallsList = Array.from(selectedStalls).sort((a, b) => a - b).join(', ');
            const businessName = document.getElementById('businessName').value;
            const totalPrice = document.getElementById('totalPrice').textContent;
            
            document.getElementById('bookingDetails').innerHTML = `
                <strong>Booking Confirmation</strong><br><br>
                <strong>Business:</strong> ${businessName}<br>
                <strong>Stalls Selected:</strong> ${stallsList}<br>
                <strong>Total Stalls:</strong> ${selectedStalls.size}<br>
                <strong>Total Amount:</strong> ${totalPrice}<br><br>
                Your booking reference number is <strong>BE2024-${Date.now().toString().slice(-6)}</strong>
            `;
            
            document.getElementById('successModal').classList.add('show');
        }

        function closeModal() {
            document.getElementById('successModal').classList.remove('show');
        }

        // Setup event listeners
        function setupEventListeners() {
            // Filter event listeners
            document.getElementById('typeFilter').addEventListener('change', applyFilters);
            document.getElementById('sectionFilter').addEventListener('change', applyFilters);
            document.getElementById('priceFilter').addEventListener('change', applyFilters);
        }

        // Apply filters
        function applyFilters() {
            const typeFilter = document.getElementById('typeFilter').value;
            const sectionFilter = document.getElementById('sectionFilter').value;
            const priceFilter = document.getElementById('priceFilter').value;
            
            for (let i = 1; i <= 268; i++) {
                const stallElement = document.getElementById(`stall-${i}`);
                const stall = stallData[i];
                let show = true;
                
                // Type filter
                if (typeFilter !== 'all') {
                    if (typeFilter === 'available' && occupiedStalls.has(i)) show = false;
                    if (typeFilter === 'occupied' && !occupiedStalls.has(i)) show = false;
                    if (typeFilter === 'eatery' && stall.type !== 'eatery') show = false;
                    if (typeFilter === 'non-eatery' && stall.type !== 'non-eatery') show = false;
                }
                
                // Section filter
                if (sectionFilter !== 'all') {
                    const sectionNum = parseInt(sectionFilter.replace('section', ''));
                    const startStall = (sectionNum - 1) * 53 + 1;
                    const endStall = Math.min(sectionNum * 53, 268);
                    if (i < startStall || i > endStall) show = false;
                }
                
                // Price filter
                if (priceFilter !== 'all') {
                    if (priceFilter === 'budget' && stall.price >= 12000) show = false;
                    if (priceFilter === 'standard' && (stall.price < 12000 || stall.price >= 15000)) show = false;
                    if (priceFilter === 'premium' && stall.price < 15000) show = false;
                }
                
                stallElement.style.opacity = show ? '1' : '0.3';
                stallElement.style.pointerEvents = show ? 'auto' : 'none';
            }
        }

        // Initialize app when page loads
        document.addEventListener('DOMContentLoaded', initializeApp);

        // Hall Display JavaScript - International Biryani Festival and Expo

    document.addEventListener('DOMContentLoaded', function() {
        // Prefetch hall data
        const hallDisplay = document.getElementById('hall-display');
        const hallId = hallDisplay.dataset.hallId;
        
        // Start loading data as soon as possible
        fetch(`/halls/${hallId}/data/`);
        
        // Load hall data and render stalls
        const hallLength = parseInt(hallDisplay.dataset.length);
        const hallBreadth = parseInt(hallDisplay.dataset.breadth);
        const stallInfo = document.getElementById('stall-info');
        const selectedStallsList = document.getElementById('selected-stalls-list');
        const selectedStallsCount = document.getElementById('selected-stalls-count');
        const totalPriceElement = document.getElementById('total-price');
        const bookNowBtn = document.getElementById('book-now-btn');
        const loadingElement = document.getElementById('loading');

        let selectedStalls = [];
        let stallData = {};
        let comboData = {};
        let stallToComboMap = {}; // Maps stall IDs to their combos

        // Determine the scale to fit the display
        const maxWidth = hallDisplay.clientWidth;
        const maxHeight = hallDisplay.clientHeight;

        const scaleX = maxWidth / hallLength;
        const scaleY = maxHeight / hallBreadth;
        const scale = Math.min(scaleX, scaleY);

        // Set the actual dimensions
        const actualWidth = hallLength * scale;
        const actualHeight = hallBreadth * scale;

        // Draw hall grid (for reference)
        for (let x = 0; x < hallLength; x++) {
            for (let y = 0; y < hallBreadth; y++) {
                const gridBox = document.createElement('div');
                gridBox.style.position = 'absolute';
                gridBox.style.left = `${x * scale}px`;
                gridBox.style.top = `${y * scale}px`;
                gridBox.style.width = `${scale}px`;
                gridBox.style.height = `${scale}px`;
                gridBox.style.border = '0.1px solid #f0f0f0';
                hallDisplay.appendChild(gridBox);
            }
        }

        // Add Entry marker (outside coordinates 14,1 to 25,1)
        const entryMarker = document.createElement('div');
        entryMarker.className = 'entry-exit-marker';
        // Position above the specified coordinates
        const entryX = ((14 + 25) / 2) * scale; // Center between 14 and 25
        const entryY = 650; // Above row 1
        entryMarker.style.left = `${entryX - 25}px`; // Center the marker
        entryMarker.style.top = `${entryY - 40}px`;
        entryMarker.innerHTML = `              
            <svg width="30" height="30" viewBox="0 0 24 24" fill="none">
                <path d="M4 15L12 9L20 15" stroke="#451a32" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
            <span class="entry-exit-label" style="top: 35px;">ENTRY</span>
        `;
        hallDisplay.appendChild(entryMarker);

        // Add Exit marker (outside coordinates 76,1 to 87,1)
        const exitMarker = document.createElement('div');
        exitMarker.className = 'entry-exit-marker';
        // Position above the specified coordinates
        const exitX = ((76 + 87) / 2) * scale; // Center between 76 and 87
        const exitY = 650; // Above row 1
        exitMarker.style.left = `${exitX - 25}px`; // Center the marker
        exitMarker.style.top = `${exitY - 40}px`;
        exitMarker.innerHTML = `
            <svg width="30" height="30" viewBox="0 0 24 24" fill="none">
                <path d="M4 9L12 15L20 9" stroke="#451a32" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
            <span class="entry-exit-label" style="top: 35px;">EXIT</span>
        `;
        hallDisplay.appendChild(exitMarker);

        // Fetch and render stalls and combos
        fetch(`/halls/${hallId}/data/`)
            .then(response => response.json())
            .then(data => {
                // Hide loading indicators
                loadingElement.style.display = 'none';
                
                // Store combo data
                data.combos.forEach(combo => {
                    comboData[combo.id] = combo;
                    
                    // Map stalls to their combos
                    combo.stall_ids.forEach(stallId => {
                        if (!stallToComboMap[stallId]) {
                            stallToComboMap[stallId] = [];
                        }
                        stallToComboMap[stallId].push(combo.id);
                    });
                });
                
                // Process each stall
                data.stalls.forEach(stall => {
                    // Store all stall data for reference
                    stallData[stall.id] = stall;
                    
                    const stallBoxes = stall.selected_boxes;

                    // Group boxes by stall number and find the boundaries
                    let minX = Infinity, minY = Infinity, maxX = -Infinity, maxY = -Infinity;

                    stallBoxes.forEach(box => {
                        minX = Math.min(minX, box.x);
                        minY = Math.min(minY, box.y);
                        maxX = Math.max(maxX, box.x);
                        maxY = Math.max(maxY, box.y);
                    });

                    // Create a single stall element
                    const stallElement = document.createElement('div');
                    
                    // Handle blocked stalls as booked stalls for display purposes
                    const displayStatus = stall.status === 'blocked' ? 'booked' : stall.status;
                    
                    // Add stall type class for styling
                    stallElement.className = `stall ${displayStatus} ${stall.stall_type}`;
                    
                    stallElement.setAttribute('data-stall-id', stall.id);
                    stallElement.setAttribute('data-stall-number', stall.stall_number);
                    stallElement.setAttribute('data-stall-status', stall.status);
                    stallElement.setAttribute('data-stall-price', stall.price);
                    stallElement.setAttribute('data-stall-type', stall.stall_type);
                    
                    // If the stall is part of a combo, add the combo class
                    if (stallToComboMap[stall.id]) {
                        stallElement.classList.add('combo');
                        // Store combo IDs as data attribute
                        stallElement.setAttribute('data-combo-ids', stallToComboMap[stall.id].join(','));
                    }
                    
                    stallElement.style.position = 'absolute';
                    stallElement.style.left = `${minX * scale}px`;
                    stallElement.style.top = `${minY * scale}px`;
                    stallElement.style.width = `${(maxX - minX + 1) * scale}px`;
                    stallElement.style.height = `${(maxY - minY + 1) * scale}px`;
                    stallElement.style.zIndex = '5'; // Ensure stalls appear above grid lines

                    // Add the stall number with font-weight 300
                    const stallLabel = document.createElement('div');
                    stallLabel.textContent = stall.stall_number;
                    stallLabel.className = 'stall-number';
                    stallLabel.style.position = 'absolute';
                    stallLabel.style.top = '50%';
                    stallLabel.style.left = '50%';
                    stallLabel.style.transform = 'translate(-50%, -50%)';
                    stallLabel.style.fontWeight = '300';
                    stallLabel.style.fontSize = `${Math.max(14, scale / 3)}px`;
                    stallLabel.style.textAlign = 'center';

                    // Add click event for available stalls only
                    if(stall.status === 'available') {
                        stallElement.addEventListener('click', function() {
                            const stallId = this.getAttribute('data-stall-id');
                            const isSelected = this.classList.contains('selected');
                            const comboIds = this.getAttribute('data-combo-ids');
                            
                            if (comboIds) {
                                // This stall is part of a combo
                                const comboIdArray = comboIds.split(',');
                                
                                if (!isSelected) {
                                    // When selecting a stall that's part of a combo, auto-select all combo stalls
                                    let selectedCombo = null;
                                    
                                    // Find the first valid combo where all stalls are available
                                    for (const comboId of comboIdArray) {
                                        const combo = comboData[comboId];
                                        if (!combo) continue;
                                        
                                        // Check if all stalls in this combo are available
                                        const allAvailable = combo.stall_ids.every(id => 
                                            stallData[id] && stallData[id].status === 'available'
                                        );
                                        
                                        if (allAvailable) {
                                            selectedCombo = combo;
                                            break;
                                        }
                                    }
                                    
                                    if (selectedCombo) {
                                        // Select all stalls in this combo automatically
                                        selectedCombo.stall_ids.forEach(id => {
                                            const comboStallElement = document.querySelector(
                                                `.stall[data-stall-id="${id}"]`
                                            );
                                            if (comboStallElement && !selectedStalls.includes(id.toString())) {
                                                comboStallElement.classList.add('selected');
                                                selectedStalls.push(id.toString());
                                            }
                                        });
                                    } else {
                                        // No valid combo (some stalls unavailable), just select this stall
                                        this.classList.add('selected');
                                        selectedStalls.push(stallId);
                                    }
                                } else {
                                    // When deselecting, check if part of a fully selected combo
                                    let comboToDeselect = null;
                                    
                                    for (const comboId of comboIdArray) {
                                        const combo = comboData[comboId];
                                        if (!combo) continue;
                                        
                                        // Check if all stalls in this combo are selected
                                        const allSelected = combo.stall_ids.every(id => 
                                            selectedStalls.includes(id.toString())
                                        );
                                        
                                        if (allSelected) {
                                            comboToDeselect = combo;
                                            break;
                                        }
                                    }
                                    
                                    if (comboToDeselect) {
                                        // Deselect all stalls in this combo
                                        comboToDeselect.stall_ids.forEach(id => {
                                            const comboStallElement = document.querySelector(
                                                `.stall[data-stall-id="${id}"]`
                                            );
                                            if (comboStallElement) {
                                                comboStallElement.classList.remove('selected');
                                            }
                                            selectedStalls = selectedStalls.filter(sid => sid !== id.toString());
                                        });
                                    } else {
                                        // Just deselect this stall
                                        this.classList.remove('selected');
                                        selectedStalls = selectedStalls.filter(id => id !== stallId);
                                    }
                                }
                            } else {
                                // Regular stall (not part of a combo), toggle selection
                                if (isSelected) {
                                    this.classList.remove('selected');
                                    selectedStalls = selectedStalls.filter(id => id !== stallId);
                                } else {
                                    this.classList.add('selected');
                                    selectedStalls.push(stallId);
                                }
                            }
                            
                            // Update selected stalls UI
                            updateSelectedStallsUI();
                        });
                    }

                    stallElement.appendChild(stallLabel);
                    hallDisplay.appendChild(stallElement);
                });
            })
            .catch(error => {
                console.error('Error loading hall data:', error);
                loadingElement.textContent = 'Error loading stalls. Please try again later.';
            });

        // Function to update the selected stalls UI
        function updateSelectedStallsUI() {
            // Clear the list
            selectedStallsList.innerHTML = '';
            
            // Update counter
            selectedStallsCount.textContent = `${selectedStalls.length} stalls selected`;
            
            if (selectedStalls.length === 0) {
                stallInfo.style.display = 'none';
                bookNowBtn.disabled = true;
                return;
            }
            
            // Show the stall info section
            stallInfo.style.display = 'block';
            bookNowBtn.disabled = false;
            
            // Group selected stalls by combo
            const comboGroups = {};
            const singleStalls = [];
            
            selectedStalls.forEach(stallId => {
                const stall = stallData[stallId];
                if (!stall) return;
                
                // Check if this stall is part of a combo where all other stalls are also selected
                let partOfSelectedCombo = false;
                
                if (stallToComboMap[stallId]) {
                    for (const comboId of stallToComboMap[stallId]) {
                        const combo = comboData[comboId];
                        if (!combo) continue;
                        
                        // Check if all stalls in this combo are selected
                        const allSelected = combo.stall_ids.every(id => 
                            selectedStalls.includes(id.toString())
                        );
                        
                        if (allSelected) {
                            // Add to combo group
                            if (!comboGroups[comboId]) {
                                comboGroups[comboId] = {
                                    combo: combo,
                                    stalls: []
                                };
                            }
                            comboGroups[comboId].stalls.push(stall);
                            partOfSelectedCombo = true;
                            break;
                        }
                    }
                }
                
                if (!partOfSelectedCombo) {
                    // Add to single stalls
                    singleStalls.push(stall);
                }
            });
            
            // Regular stall count for discount calculation
            const regularStallCount = singleStalls.length;
            
            // Calculate base price for regular stalls
            let regularStallBasePrice = 0;
            singleStalls.forEach(stall => {
                regularStallBasePrice += parseFloat(stall.price);
            });
            
            // Calculate discount based on new requirements
            let discountAmount = 0;
            let discountedRegularPrice = regularStallBasePrice;
            let discountPerStall = 0;
            
            if (regularStallCount === 1) {
                // No discount
                discountAmount = 0;
            } else if (regularStallCount === 2) {
                // Flat ‚Çπ5,000 discount
                discountAmount = 5000;
                discountPerStall = 2500; // For display purposes only
            } else if (regularStallCount >= 3) {
                // ‚Çπ5,000 discount per stall
                discountAmount = 5000 * regularStallCount;
                discountPerStall = 5000;
            }
            
            // Apply discount
            discountedRegularPrice = regularStallBasePrice - discountAmount;
            
            // Calculate combo stall price (no discount)
            let comboStallPrice = 0;
            Object.values(comboGroups).forEach(group => {
                comboStallPrice += parseFloat(group.combo.price);
            });
            
            // Total price
            const totalPrice = discountedRegularPrice + comboStallPrice;
            
            // Calculate discount percentage for display purposes
            let discountPercentage = 0;
            if (regularStallBasePrice > 0 && discountAmount > 0) {
                discountPercentage = (discountAmount / regularStallBasePrice) * 100;
                discountPercentage = discountPercentage.toFixed(2); // Format to 2 decimal places
            }
            
            // Add each stall to the UI
            // First add regular stalls
            singleStalls.forEach(stall => {
                const stallItem = document.createElement('div');
                stallItem.className = 'selected-stall-item';
                
                stallItem.innerHTML = `
                    Stall #${stall.stall_number} 
                    <span class="remove-stall" data-stall-id="${stall.id}">√ó</span>
                `;
                
                selectedStallsList.appendChild(stallItem);
                
                // Add click event to remove button
                stallItem.querySelector('.remove-stall').addEventListener('click', function() {
                    const stallId = this.getAttribute('data-stall-id');
                    const stallElement = document.querySelector(`.stall[data-stall-id="${stallId}"]`);
                    if (stallElement) {
                        stallElement.classList.remove('selected');
                    }
                    selectedStalls = selectedStalls.filter(id => id !== stallId);
                    updateSelectedStallsUI();
                });
            });
            
            // Then add combo stalls - CONSOLIDATED VERSION
            Object.values(comboGroups).forEach(group => {
                const comboItem = document.createElement('div');
                comboItem.className = 'selected-stall-item combo-stall-item';
                
                // Create a comma-separated list of stall numbers
                const stallNumbers = group.stalls.map(stall => stall.stall_number).join(', ');
                
                comboItem.innerHTML = `
                    <span>Combo Package: Stalls #${stallNumbers}</span> <span class="remove-stall" data-combo-id="${group.combo.id}">√ó</span>
                `;
                selectedStallsList.appendChild(comboItem);
                
                // Add click event to remove button that removes the whole combo
                comboItem.querySelector('.remove-stall').addEventListener('click', function() {
                    const comboId = this.getAttribute('data-combo-id');
                    const combo = comboData[comboId];
                    
                    if (combo) {
                        // Deselect all stalls in this combo
                        combo.stall_ids.forEach(id => {
                            const comboStallElement = document.querySelector(
                                `.stall[data-stall-id="${id}"]`
                            );
                            if (comboStallElement) {
                                comboStallElement.classList.remove('selected');
                            }
                            selectedStalls = selectedStalls.filter(sid => sid !== id.toString());
                        });
                    }
                    
                    updateSelectedStallsUI();
                });
            });
            
            // Update price information
            let priceInfo = '';
            
            if (regularStallCount > 0) {
                priceInfo += `Regular Stalls: ‚Çπ${Math.round(regularStallBasePrice)}`;
                
                if (discountAmount > 0) {
                    if (regularStallCount === 2) {
                        priceInfo += ` <span style="color: #e91e63;">(Flat ‚Çπ${discountAmount} discount)</span><br>`;
                    } else {
                        priceInfo += ` <span style="color: #e91e63;">(‚Çπ${discountPerStall} √ó ${regularStallCount} stalls = -‚Çπ${discountAmount})</span><br>`;
                    }
                    priceInfo += `Discounted Price: ‚Çπ${Math.round(discountedRegularPrice)}<br>`;
                } else {
                    priceInfo += `<br>`;
                }
            }
            
            if (Object.keys(comboGroups).length > 0) {
                priceInfo += `Combo Stalls: ‚Çπ${Math.round(comboStallPrice)}<br>`;
            }
            
            priceInfo += `<strong>Total: ‚Çπ${Math.round(totalPrice)}</strong>`;
            
            totalPriceElement.innerHTML = priceInfo;
            
            // Update the book now button with the correct stall IDs
            bookNowBtn.onclick = function() {
                if (selectedStalls.length > 0) {
                    // Redirect to booking form with selected stall IDs
                    window.location.href = `/stalls/book/?stall_ids=${selectedStalls.join(',')}`;
                }
            };
        }
    });
    </script>
</body>
</html>